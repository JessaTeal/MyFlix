{"dependencies":[{"name":"utils-merge","loc":{"line":1,"column":20}}],"generated":{"js":"var merge = require('utils-merge');\n\nfunction SessionManager(options, serializeUser) {\n  if (typeof options == 'function') {\n    serializeUser = options;\n    options = undefined;\n  }\n  options = options || {};\n  \n  this._key = options.key || 'passport';\n  this._serializeUser = serializeUser;\n}\n\nSessionManager.prototype.logIn = function(req, user, options, cb) {\n  if (typeof options == 'function') {\n    cb = options;\n    options = {};\n  }\n  options = options || {};\n  \n  if (!req.session) { return cb(new Error('Login sessions require session support. Did you forget to use `express-session` middleware?')); }\n  \n  var self = this;\n  var prevSession = req.session;\n  \n  // regenerate the session, which is good practice to help\n  // guard against forms of session fixation\n  req.session.regenerate(function(err) {\n    if (err) {\n      return cb(err);\n    }\n    \n    self._serializeUser(user, req, function(err, obj) {\n      if (err) {\n        return cb(err);\n      }\n      if (options.keepSessionInfo) {\n        merge(req.session, prevSession);\n      }\n      if (!req.session[self._key]) {\n        req.session[self._key] = {};\n      }\n      // store user information in session, typically a user id\n      req.session[self._key].user = obj;\n      // save the session before redirection to ensure page\n      // load does not happen before session is saved\n      req.session.save(function(err) {\n        if (err) {\n          return cb(err);\n        }\n        cb();\n      });\n    });\n  });\n}\n\nSessionManager.prototype.logOut = function(req, options, cb) {\n  if (typeof options == 'function') {\n    cb = options;\n    options = {};\n  }\n  options = options || {};\n  \n  if (!req.session) { return cb(new Error('Login sessions require session support. Did you forget to use `express-session` middleware?')); }\n  \n  var self = this;\n  \n  // clear the user from the session object and save.\n  // this will ensure that re-using the old session id\n  // does not have a logged in user\n  if (req.session[this._key]) {\n    delete req.session[this._key].user;\n  }\n  var prevSession = req.session;\n  \n  req.session.save(function(err) {\n    if (err) {\n      return cb(err)\n    }\n  \n    // regenerate the session, which is good practice to help\n    // guard against forms of session fixation\n    req.session.regenerate(function(err) {\n      if (err) {\n        return cb(err);\n      }\n      if (options.keepSessionInfo) {\n        merge(req.session, prevSession);\n      }\n      cb();\n    });\n  });\n}\n\n\nmodule.exports = SessionManager;\n"},"hash":"f940a8a4e1ae330e79f5212444ef685a"}